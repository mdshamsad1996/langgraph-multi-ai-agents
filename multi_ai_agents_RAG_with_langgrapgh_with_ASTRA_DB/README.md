### End to End Multi AI Agents RAG With LangGraph AstraDB And Llama 3.1

#### Architecture:

![Architecture Diagram]("architecture.png")

#### create ```retriever``` for astradb vectro store
-   Initialize the astra sb connection
-   Load and Split Documents using ```RecursiveCharacterTextSplitter``` 
-   Embed document using ```sentence-transformers/all-MiniLM-L6-v2``` model and store in Cassandra db table ```qa_mini_demo```
-   create a ```retriever``` using ```retriever = astra_vector_store.as_retriever()```

#### create ```wiki``` object of ```WikipediaQueryRun``` 
-   create ```WikipediaAPIWrapper``` object with ```top_k_results=1``` and ```doc_content_chars=200```
-   create object of ```WikipediaQueryRun``` to run against ```WikipediaAPIWrapper```
#### create a ```RouteQuery``` classs
-   ```RouteQuery``` class defines a model that routes a user query to the appropriate data source based on a literal selection of either ```vectorstore``` or ```wiki_search``` Here's the structure
```
class RouteQuery(BaseModel):
  """Route a user query to the most relevant data source. """
  datasource: Literal["vectorstore", "wiki_search"] = Field(
      ...,
      description="Given a user question choose to route it to wikipedia or vector store.",
  )

```
#### structure the llm based on ```RouteQuery``` class
-   structure the output of a language model based on the RouteQuery class. This will enable the LLM to return structured responses following the schema you defined in RouteQuery
```
strutured_llm_router = llm.with_structured_output(RouteQuery)
```

#### Combined the route prompt with the structured LLM router
```
question_router = route_prompt | strutured_llm_router
```
#### Create a ```GraphState``` class
-   The GraphState class is a type definition used to represent the state of a graph in the workflow.
-   ```question``` Represents the user's input question. This is the core query that the user asks the system.
-   ```generation``` Stores the response generated by the language model (LLM).
-   ```documents: List[str]``` Holds the list of documents retrieved from either the vector store (if the query is routed to the vector store) or Wikipedia (if routed to a wiki search).
     ````
      class GraphState(TypedDict):
          """
            Represents the state of the graph
            Attributes:
              question: Question
              generation: LLM generation
              documents: list of documents
          """
          question: str
          generation: str
          documents: List[str]
    ````
#### create ```retrieve``` method to retrieved documents from vectorstore and ```wiki_search``` method to retrieved from wikipedia
-   The ```retrieve``` function is responsible for fetching relevant documents based on a user's question within a graph-based workflow.
-   The ```wiki_search``` function retrieves relevant documents from Wikipedia based on a user's question within a graph-based workflow.

#### create ```route_question``` method
-   The ```route_question``` function is responsible for determining the appropriate next step in a workflow based on the user's question. It decides whether to route the question to a Wikipedia search or to a Retrieval-Augmented Generation (RAG) process using a vector store

#### Setup a stateful graph workflow using then ```langgraph``` library
-   These imports bring in the necessary components to define and manage a state graph workflow:
    - ```END:``` Represents the endpoint of the workflow.
    - ```StateGraph:``` A class to create a stateful graph.
    - ```START:``` Represents the starting point of the workflow.
-   creating  a```StateGraph```
    - A new ```StateGraph``` object is created, initialized with ```GraphState```, which defines the structure of the graph's state (e.g., including attributes like question, generation, and documents).  
    ```python
        workflow = StateGraph(GraphState)
    ````
-   Defines the nodes
    -    Two nodes are added to the graph:
"wikisearch": Associated with the wiki_search function for conducting Wikipedia searches.

    - "retrieve": Associated with the retrieve function for fetching documents from a vector store.
    ```python
        workflow.add_node("wikisearch", wiki_search) # web search
        workflow.add_node("retrieve", retrieve) # retrieve

    ```
-   Building the Graph:
    -   This method adds conditional edges to the graph:
        -  ```From START:``` The initial point of the workflow.
        -  ```To:``` Depending on the output of the route_question function:
        -  If the output is "wiki_search", route to the "wikisearch" node.
        -  If the output is "vectorstore", route to the "retrieve" node.
-    Adding Edges to End Nodes:
        -  Edges are added to connect both the retrieve and wikisearch nodes to the END node marking the conclusion of the workflow after either process completes.
            ```python
            workflow.add_edge("retrieve", END)
            workflow.add_edge("wikisearch", END)
    
- Compiling the Workflow:
    -    This line compiles the defined workflow into a runnable application, which can now process inputs based on the defined nodes and routing logic
    ```app = workflow.compile()```
    

  